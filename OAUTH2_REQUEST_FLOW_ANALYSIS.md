# OAuth2 æ¶æ„ä¸‹è¯·æ±‚è·¯å¾„åˆ†æ

## ğŸ“‹ åœºæ™¯è¯´æ˜

åˆ†æåœ¨ OAuth2 æ¶æ„ä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚ä»**ç½‘å…³**åˆ° **wechatwork ä¸šåŠ¡æœåŠ¡**çš„å®Œæ•´è·¯å¾„ã€‚

---

## ğŸ”„ ä¸¤ç§æ¶æ„æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆä¸€ï¼šç½‘å…³ç»Ÿä¸€éªŒè¯ Tokenï¼ˆæ¨èï¼‰â­

**æ¶æ„ç‰¹ç‚¹**ï¼š
- ç½‘å…³ä½œä¸º Resource Serverï¼Œç»Ÿä¸€éªŒè¯ Token
- åç«¯æœåŠ¡ä¸éœ€è¦é‡å¤éªŒè¯ Token
- Token éªŒè¯é€»è¾‘é›†ä¸­åœ¨ç½‘å…³å±‚

**è¯·æ±‚è·¯å¾„**ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
ç½‘å…³ (Gateway:8080)
    â”œâ”€ 1. æå– Access Token (ä» Authorization Header)
    â”œâ”€ 2. éªŒè¯ Token (è°ƒç”¨ Authorization Server çš„ /oauth2/jwks)
    â”œâ”€ 3. è§£æ Tokenï¼Œæå–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
    â”œâ”€ 4. è®¾ç½®åˆ° SecurityContext (WebFlux çš„ ReactiveSecurityContext)
    â”œâ”€ 5. è·¯ç”±åŒ¹é… (åŒ¹é…åˆ° wechatwork æœåŠ¡)
    â”œâ”€ 6. è½¬å‘è¯·æ±‚åˆ° service-wechatwork
    â”‚   â””â”€ è¯·æ±‚å¤´å¯èƒ½åŒ…å«ï¼šX-User-Id, X-Username, X-Authorities ç­‰
    â†“
service-wechatwork (Resource Server)
    â”œâ”€ æ¥æ”¶è¯·æ±‚ï¼ˆå·²é€šè¿‡ç½‘å…³éªŒè¯ï¼ŒToken å·²è§£æï¼‰
    â”œâ”€ ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆç½‘å…³ä¼ é€’ï¼‰
    â””â”€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘
```

**è¯¦ç»†æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚
â”‚  (Browser/  â”‚
â”‚   App)      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP Request
       â”‚ GET /wechatwork/xxx
       â”‚ Authorization: Bearer <access_token>
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç½‘å…³ (Gateway:8080)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Spring Cloud Gateway                â”‚  â”‚
â”‚  â”‚  (WebFlux - å“åº”å¼)                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  OAuth2 Resource Server              â”‚  â”‚
â”‚  â”‚  (ç»Ÿä¸€éªŒè¯ Token)                     â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  1. æå– Token                        â”‚  â”‚
â”‚  â”‚     Authorization: Bearer <token>      â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  2. éªŒè¯ Token                        â”‚  â”‚
â”‚  â”‚     â””â”€> è°ƒç”¨ Authorization Server    â”‚  â”‚
â”‚  â”‚         GET /oauth2/jwks              â”‚  â”‚
â”‚  â”‚         (è·å–å…¬é’¥éªŒè¯ç­¾å)             â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  3. è§£æ Token                        â”‚  â”‚
â”‚  â”‚     â””â”€> æå– claims:                  â”‚  â”‚
â”‚  â”‚         - userId                      â”‚  â”‚
â”‚  â”‚         - username                    â”‚  â”‚
â”‚  â”‚         - authorities                 â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  4. è®¾ç½®åˆ° ReactiveSecurityContext   â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  5. è·¯ç”±åŒ¹é…                          â”‚  â”‚
â”‚  â”‚     Path: /wechatwork/**              â”‚  â”‚
â”‚  â”‚     â””â”€> lb://service-wechatwork       â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  6. æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´ï¼ˆå¯é€‰ï¼‰         â”‚  â”‚
â”‚  â”‚     X-User-Id: <userId>               â”‚  â”‚
â”‚  â”‚     X-Username: <username>            â”‚  â”‚
â”‚  â”‚     X-Authorities: <authorities>      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ HTTP Request (å·²é€šè¿‡éªŒè¯)
       â”‚ GET /wechatwork/xxx
       â”‚ Authorization: Bearer <access_token>
       â”‚ X-User-Id: 123
       â”‚ X-Username: testuser
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      service-wechatwork                     â”‚
â”‚      (Resource Server - ç®€åŒ–ç‰ˆ)              â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¸šåŠ¡ Controller                     â”‚  â”‚
â”‚  â”‚  @GetMapping("/wechatwork/xxx")      â”‚  â”‚
â”‚  â”‚  public Result xxx(                  â”‚  â”‚
â”‚  â”‚      @RequestHeader("X-User-Id")     â”‚  â”‚
â”‚  â”‚          Long userId,                â”‚  â”‚
â”‚  â”‚      @RequestHeader("X-Username")    â”‚  â”‚
â”‚  â”‚          String username             â”‚  â”‚
â”‚  â”‚  ) {                                 â”‚  â”‚
â”‚  â”‚      // æ‰§è¡Œä¸šåŠ¡é€»è¾‘                  â”‚  â”‚
â”‚  â”‚  }                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  æ³¨æ„ï¼šå¦‚æœç½‘å…³å·²ç»éªŒè¯ï¼Œè¿™é‡Œå¯ä»¥ï¼š          â”‚
â”‚  - ä¸é…ç½® Resource Serverï¼ˆç®€åŒ–ï¼‰          â”‚
â”‚  - æˆ–é…ç½®ä¸ºä»…ä¿¡ä»»ç½‘å…³ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… Token éªŒè¯é€»è¾‘é›†ä¸­ï¼Œæ˜“äºç®¡ç†å’Œä¼˜åŒ–
- âœ… åç«¯æœåŠ¡ç®€åŒ–ï¼Œä¸éœ€è¦é‡å¤éªŒè¯
- âœ… ç»Ÿä¸€å¤„ç†è®¤è¯å¤±è´¥ï¼ˆ401ï¼‰
- âœ… å¯ä»¥åœ¨ç½‘å…³å±‚åšæƒé™æ§åˆ¶
- âœ… å‡å°‘å¯¹ Authorization Server çš„è¯·æ±‚ï¼ˆç½‘å…³ç¼“å­˜ JWK Setï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ ç½‘å…³éœ€è¦é…ç½® OAuth2 Resource Server
- âš ï¸ ç½‘å…³éœ€è¦èƒ½å¤Ÿè®¿é—® Authorization Server

---

### æ–¹æ¡ˆäºŒï¼šåç«¯æœåŠ¡å„è‡ªéªŒè¯ Tokenï¼ˆæ–‡æ¡£å½“å‰æ–¹æ¡ˆï¼‰

**æ¶æ„ç‰¹ç‚¹**ï¼š
- ç½‘å…³åªåšè·¯ç”±è½¬å‘ï¼Œä¸éªŒè¯ Token
- æ¯ä¸ª Resource Server è‡ªå·±éªŒè¯ Token
- Token éªŒè¯é€»è¾‘åˆ†æ•£åœ¨å„ä¸ªæœåŠ¡

**è¯·æ±‚è·¯å¾„**ï¼š
```
å®¢æˆ·ç«¯è¯·æ±‚
    â†“
ç½‘å…³ (Gateway:8080)
    â”œâ”€ 1. è·¯ç”±åŒ¹é… (åŒ¹é…åˆ° wechatwork æœåŠ¡)
    â”œâ”€ 2. è½¬å‘è¯·æ±‚åˆ° service-wechatwork
    â”‚   â””â”€ ä¿æŒåŸå§‹ Authorization Header
    â†“
service-wechatwork (Resource Server)
    â”œâ”€ 1. æå– Access Token
    â”œâ”€ 2. éªŒè¯ Token (è°ƒç”¨ Authorization Server çš„ /oauth2/jwks)
    â”œâ”€ 3. è§£æ Tokenï¼Œæå–ç”¨æˆ·ä¿¡æ¯å’Œæƒé™
    â”œâ”€ 4. è®¾ç½®åˆ° SecurityContext
    â””â”€ 5. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
```

**è¯¦ç»†æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å®¢æˆ·ç«¯     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ HTTP Request
       â”‚ GET /wechatwork/xxx
       â”‚ Authorization: Bearer <access_token>
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç½‘å…³ (Gateway:8080)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Spring Cloud Gateway                â”‚  â”‚
â”‚  â”‚  (ä»…åšè·¯ç”±è½¬å‘)                       â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  1. è·¯ç”±åŒ¹é…                          â”‚  â”‚
â”‚  â”‚     Path: /wechatwork/**              â”‚  â”‚
â”‚  â”‚     â””â”€> lb://service-wechatwork       â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  2. è½¬å‘è¯·æ±‚ï¼ˆä¿æŒåŸå§‹è¯·æ±‚å¤´ï¼‰          â”‚  â”‚
â”‚  â”‚     Authorization: Bearer <token>     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ HTTP Request (æœªéªŒè¯)
       â”‚ GET /wechatwork/xxx
       â”‚ Authorization: Bearer <access_token>
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      service-wechatwork                     â”‚
â”‚      (Resource Server - å®Œæ•´éªŒè¯)            â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  OAuth2 Resource Server             â”‚  â”‚
â”‚  â”‚  (è‡ªå·±éªŒè¯ Token)                    â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  1. æå– Token                        â”‚  â”‚
â”‚  â”‚     Authorization: Bearer <token>     â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  2. éªŒè¯ Token                        â”‚  â”‚
â”‚  â”‚     â””â”€> è°ƒç”¨ Authorization Server    â”‚  â”‚
â”‚  â”‚         GET /oauth2/jwks              â”‚  â”‚
â”‚  â”‚         (æ¯ä¸ªæœåŠ¡éƒ½è¦è°ƒç”¨)              â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  3. è§£æ Token                        â”‚  â”‚
â”‚  â”‚     â””â”€> æå– claims                   â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  4. è®¾ç½®åˆ° SecurityContext            â”‚  â”‚
â”‚  â”‚                                        â”‚  â”‚
â”‚  â”‚  5. æƒé™æ£€æŸ¥                          â”‚  â”‚
â”‚  â”‚     @PreAuthorize("hasAuthority(...)") â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  ä¸šåŠ¡ Controller                     â”‚  â”‚
â”‚  â”‚  @GetMapping("/wechatwork/xxx")      â”‚  â”‚
â”‚  â”‚  public Result xxx(                  â”‚  â”‚
â”‚  â”‚      @AuthenticationPrincipal       â”‚  â”‚
â”‚  â”‚          Jwt jwt                     â”‚  â”‚
â”‚  â”‚  ) {                                 â”‚  â”‚
â”‚  â”‚      Long userId = jwt.getClaimAsLong("userId"); â”‚
â”‚  â”‚      // æ‰§è¡Œä¸šåŠ¡é€»è¾‘                  â”‚  â”‚
â”‚  â”‚  }                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¼˜ç‚¹**ï¼š
- âœ… åç«¯æœåŠ¡ç‹¬ç«‹ï¼Œä¸ä¾èµ–ç½‘å…³
- âœ… å¯ä»¥ç›´æ¥è®¿é—®åç«¯æœåŠ¡ï¼ˆç»•è¿‡ç½‘å…³ï¼‰
- âœ… æ¯ä¸ªæœåŠ¡å¯ä»¥æœ‰ä¸åŒçš„æƒé™æ§åˆ¶ç­–ç•¥

**ç¼ºç‚¹**ï¼š
- âš ï¸ æ¯ä¸ªæœåŠ¡éƒ½è¦éªŒè¯ Tokenï¼Œé‡å¤å·¥ä½œ
- âš ï¸ æ¯ä¸ªæœåŠ¡éƒ½è¦è®¿é—® Authorization Serverï¼Œå¢åŠ ç½‘ç»œå¼€é”€
- âš ï¸ Token éªŒè¯é€»è¾‘åˆ†æ•£ï¼Œéš¾ä»¥ç»Ÿä¸€ç®¡ç†

---

## ğŸ¯ æ¨èæ–¹æ¡ˆï¼šç½‘å…³ç»Ÿä¸€éªŒè¯ï¼ˆæ–¹æ¡ˆä¸€ï¼‰

### å®ç°æ­¥éª¤

#### 1. ç½‘å…³é…ç½® OAuth2 Resource Server

**æ·»åŠ ä¾èµ–**ï¼ˆ`gateway/pom.xml`ï¼‰ï¼š
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-oauth2-resource-server</artifactId>
</dependency>
```

**é…ç½®ç±»**ï¼ˆ`gateway/src/main/java/com/scccy/gateway/config/ResourceServerConfig.java`ï¼‰ï¼š
```java
@Configuration
@EnableWebFluxSecurity
public class ResourceServerConfig {

    @Value("${spring.security.oauth2.resourceserver.jwt.issuer-uri}")
    private String issuerUri;

    @Bean
    public SecurityWebFilterChain securityWebFilterChain(ServerHttpSecurity http) {
        http
            .authorizeExchange(exchanges -> exchanges
                .pathMatchers("/oauth2/**", "/login", "/actuator/**").permitAll()  // å…¬å¼€ç«¯ç‚¹
                .anyExchange().authenticated()  // å…¶ä»–è·¯å¾„éœ€è¦è®¤è¯
            )
            .oauth2ResourceServer(oauth2 -> oauth2
                .jwt(jwt -> jwt
                    .jwkSetUri(issuerUri + "/oauth2/jwks")
                    // æˆ–ä½¿ç”¨è‡ªåŠ¨å‘ç°
                    // .issuerLocation(issuerUri)
                )
            )
            .csrf(csrf -> csrf.disable());  // Gateway é€šå¸¸ç¦ç”¨ CSRF
        
        return http.build();
    }
}
```

**é…ç½®æ–‡ä»¶**ï¼ˆ`gateway/src/main/resources/dev/application.yml`ï¼‰ï¼š
```yaml
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080  # Authorization Server åœ°å€
```

#### 2. é…ç½®ç½‘å…³è·¯ç”±

**Nacos é…ç½®**ï¼ˆ`gateway.yaml`ï¼‰ï¼š
```yaml
spring:
  cloud:
    gateway:
      routes:
        # ä¼ä¸šå¾®ä¿¡æœåŠ¡è·¯ç”±
        - id: wechatwork-service
          uri: lb://service-wechatwork
          predicates:
            - Path=/wechatwork/**
          filters:
            - StripPrefix=0  # ä¿ç•™ /wechatwork å‰ç¼€
            # å¯é€‰ï¼šæ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
            - name: AddRequestHeader
              args:
                name: X-User-Id
                value: ${T(java.util.UUID).randomUUID()}  # éœ€è¦ä» SecurityContext è·å–
```

**æ³¨æ„**ï¼šåœ¨ Gateway ä¸­ä» SecurityContext è·å–ç”¨æˆ·ä¿¡æ¯éœ€è¦è‡ªå®šä¹‰ Filterï¼š

```java
@Component
public class UserInfoGatewayFilter implements GatewayFilter, Ordered {

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        return ReactiveSecurityContextHolder.getContext()
            .map(SecurityContext::getAuthentication)
            .cast(JwtAuthenticationToken.class)
            .map(JwtAuthenticationToken::getToken)
            .flatMap(jwt -> {
                // æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
                ServerHttpRequest request = exchange.getRequest().mutate()
                    .header("X-User-Id", String.valueOf(jwt.getClaimAsLong("userId")))
                    .header("X-Username", jwt.getClaimAsString("username"))
                    .header("X-Authorities", String.join(",", jwt.getClaimAsStringList("authorities")))
                    .build();
                
                return chain.filter(exchange.mutate().request(request).build());
            })
            .switchIfEmpty(chain.filter(exchange));  // å¦‚æœæ²¡æœ‰è®¤è¯ä¿¡æ¯ï¼Œç»§ç»­è½¬å‘
    }

    @Override
    public int getOrder() {
        return -100;  // åœ¨è·¯ç”±ä¹‹å‰æ‰§è¡Œ
    }
}
```

#### 3. åç«¯æœåŠ¡ç®€åŒ–é…ç½®

**service-wechatwork** å¯ä»¥ï¼š
- **é€‰é¡¹ A**ï¼šå®Œå…¨ä¸é…ç½® Resource Serverï¼Œåªä¿¡ä»»ç½‘å…³ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯
- **é€‰é¡¹ B**ï¼šé…ç½® Resource Serverï¼Œä½†ä»…ä½œä¸ºå¤‡ç”¨éªŒè¯ï¼ˆç½‘å…³éªŒè¯å¤±è´¥æ—¶ï¼‰

**é€‰é¡¹ A ç¤ºä¾‹**ï¼ˆä¸é…ç½® Resource Serverï¼‰ï¼š
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/wechatwork/callBack").permitAll()  // å›è°ƒæ¥å£å…¬å¼€
                .anyRequest().authenticated()  // å…¶ä»–æ¥å£éœ€è¦ç½‘å…³ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯
            )
            .sessionManagement(session -> session
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            )
            .csrf(csrf -> csrf.disable());
        
        return http.build();
    }
}
```

---

## ğŸ“Š å®Œæ•´è¯·æ±‚è·¯å¾„ç¤ºä¾‹

### åœºæ™¯ï¼šå®¢æˆ·ç«¯è¯·æ±‚ `GET /wechatwork/users/123`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚                                                â”‚
â”‚     GET http://gateway:8080/wechatwork/users/123                 â”‚
â”‚     Headers:                                                     â”‚
â”‚       Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ç½‘å…³æ¥æ”¶è¯·æ±‚ (Gateway:8080)                                  â”‚
â”‚     â”œâ”€ Spring Cloud Gateway è·¯ç”±åŒ¹é…                            â”‚
â”‚     â”‚   â””â”€> åŒ¹é…åˆ° route: wechatwork-service                    â”‚
â”‚     â”‚                                                             â”‚
â”‚     â”œâ”€ OAuth2 Resource Server éªŒè¯                               â”‚
â”‚     â”‚   â”œâ”€ æå– Token: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9â”‚
â”‚     â”‚   â”œâ”€ éªŒè¯ç­¾å: è°ƒç”¨ http://auth-service:8080/oauth2/jwks   â”‚
â”‚     â”‚   â”œâ”€ è§£æ Token:                                           â”‚
â”‚     â”‚   â”‚     {                                                   â”‚
â”‚     â”‚   â”‚       "userId": 123,                                   â”‚
â”‚     â”‚   â”‚       "username": "testuser",                          â”‚
â”‚     â”‚   â”‚       "authorities": ["USER_READ", "USER_WRITE"]       â”‚
â”‚     â”‚   â”‚     }                                                   â”‚
â”‚     â”‚   â””â”€ è®¾ç½®åˆ° ReactiveSecurityContext                        â”‚
â”‚     â”‚                                                             â”‚
â”‚     â””â”€ æ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´                                       â”‚
â”‚         X-User-Id: 123                                           â”‚
â”‚         X-Username: testuser                                     â”‚
â”‚         X-Authorities: USER_READ,USER_WRITE                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç½‘å…³è½¬å‘è¯·æ±‚åˆ° service-wechatwork                            â”‚
â”‚     GET http://service-wechatwork:8082/wechatwork/users/123      â”‚
â”‚     Headers:                                                     â”‚
â”‚       Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9â”‚
â”‚       X-User-Id: 123                                             â”‚
â”‚       X-Username: testuser                                      â”‚
â”‚       X-Authorities: USER_READ,USER_WRITE                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. service-wechatwork æ¥æ”¶è¯·æ±‚                                   â”‚
â”‚     â”œâ”€ ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯                                       â”‚
â”‚     â”‚   Long userId = request.getHeader("X-User-Id");           â”‚
â”‚     â”‚                                                             â”‚
â”‚     â””â”€ æ‰§è¡Œä¸šåŠ¡é€»è¾‘                                              â”‚
â”‚         @GetMapping("/wechatwork/users/{id}")                    â”‚
â”‚         public Result getUser(@PathVariable Long id) {           â”‚
â”‚             // ä½¿ç”¨ userId æ‰§è¡Œä¸šåŠ¡é€»è¾‘                           â”‚
â”‚         }                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” å…³é”®å†³ç­–ç‚¹

### 1. ç½‘å…³æ˜¯å¦éªŒè¯ Tokenï¼Ÿ

**æ¨èï¼šæ˜¯** âœ…
- é›†ä¸­ç®¡ç†ï¼Œæ˜“äºç»´æŠ¤
- ç»Ÿä¸€å¤„ç†è®¤è¯å¤±è´¥
- å‡å°‘åç«¯æœåŠ¡å¤æ‚åº¦

### 2. åç«¯æœåŠ¡æ˜¯å¦è¿˜éœ€è¦éªŒè¯ Tokenï¼Ÿ

**æ¨èï¼šå¯é€‰** ğŸ¤”
- **å¦‚æœç½‘å…³éªŒè¯**ï¼šåç«¯å¯ä»¥ç®€åŒ–ï¼Œåªä¿¡ä»»ç½‘å…³ä¼ é€’çš„ç”¨æˆ·ä¿¡æ¯
- **å¦‚æœéœ€è¦ç›´æ¥è®¿é—®åç«¯**ï¼šåç«¯å¯ä»¥é…ç½® Resource Server ä½œä¸ºå¤‡ç”¨éªŒè¯

### 3. å¦‚ä½•ä¼ é€’ç”¨æˆ·ä¿¡æ¯ï¼Ÿ

**æ–¹æ¡ˆ A**ï¼šé€šè¿‡è¯·æ±‚å¤´ä¼ é€’ï¼ˆæ¨èï¼‰
- `X-User-Id`: ç”¨æˆ·ID
- `X-Username`: ç”¨æˆ·å
- `X-Authorities`: æƒé™åˆ—è¡¨

**æ–¹æ¡ˆ B**ï¼šåç«¯æœåŠ¡å†æ¬¡éªŒè¯ Token
- ä» Authorization Header æå– Token
- è‡ªå·±éªŒè¯ï¼ˆéœ€è¦é…ç½® Resource Serverï¼‰

---

## ğŸ“ æ€»ç»“

### æ¨èæ¶æ„ï¼ˆæ–¹æ¡ˆä¸€ï¼‰

```
å®¢æˆ·ç«¯ â†’ ç½‘å…³ï¼ˆéªŒè¯ Tokenï¼‰â†’ åç«¯æœåŠ¡ï¼ˆä¿¡ä»»ç½‘å…³ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… Token éªŒè¯é€»è¾‘é›†ä¸­
- âœ… åç«¯æœåŠ¡ç®€åŒ–
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âœ… æ˜“äºæ‰©å±•å’Œç»´æŠ¤

**å®ç°è¦ç‚¹**ï¼š
1. ç½‘å…³é…ç½® OAuth2 Resource Server
2. ç½‘å…³éªŒè¯ Token åï¼Œæ·»åŠ ç”¨æˆ·ä¿¡æ¯åˆ°è¯·æ±‚å¤´
3. åç«¯æœåŠ¡ä»è¯·æ±‚å¤´è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œæˆ–é…ç½®ç®€åŒ–ç‰ˆ Resource Server

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-01-XX

